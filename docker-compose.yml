version: '3.8'

services:
  # --- Atomspace API ---
  atomspace-api:
    image: tarikua123/atomspace-api:latest
    container_name: atomspace-api
    ports:
      - "${ATOMSPACE_API_PORT:-8000}:${API_PORT:-8000}"
    environment:
      - HUGEGRAPH_HOST=hugegraph-atomspace
      - HUGEGRAPH_PORT=8080
      - HUGEGRAPH_GRAPH=hugegraph
      - ANNOTATION_SERVICE_URL=http://annotation_service:${ANNOTATION_SERVICE_PORT:-8001}/annotation/load
      - API_PORT=${API_PORT:-8000}
      - NEO4J_HOST=neo4j
      - NEO4J_PORT=7687
      - NEO4J_HTTP_PORT=7474
      - NEO4J_BOLT_PORT=7687
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - LLM_API_KEY=${LLM_API_KEY}
      - NEO4J_USERNAME=${NEO4J_USERNAME:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-atomspace123}
      - NEO4J_DATABASE=${NEO4J_DATABASE:-neo4j}
    volumes:
      - ./custom-atomspace-builder/output:/app/output
      - atomspace_logs:/app/logs
      - shared_output:/shared/output
    depends_on:
      hugegraph:
        condition: service_started
      neo4j:
        condition: service_started
    networks:
      - atomspace-network
    restart: always

  # --- HugeGraph ---
  hugegraph:
    image: hugegraph/hugegraph:1.5.0
    container_name: hugegraph-atomspace
    ports:
      - "${HUGEGRAPH_PORT_EXTERNAL:-8080}:8080"
      - "8182:8182"
    environment:
      - HUGEGRAPH_CONF=/hugegraph/conf
    volumes:
      - hugegraph_data:/hugegraph/data
      - hugegraph_logs:/hugegraph/logs
    networks:
      - atomspace-network
    restart: unless-stopped

  # --- Annotation Service (Backend) ---
  annotation_service:
    image: deazstar/custom-query-builder:annotation-service-backend-general
    container_name: annotation_service
    ports:
      - "${ANNOTATION_SERVICE_PORT:-8001}:${APP_PORT:-8001}"
    command: python run.py
    restart: always
    volumes:
      - ./submodules/annotation-query-backend-general:/app
      - ./custom-atomspace-builder/output:/shared/output
    depends_on:
      - mongodb
      - redis
    environment:
      - MONGO_URI=mongodb://mongodb:27017/annotation
      - APP_PORT=${APP_PORT:-8001}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_URL=redis://redis:6379/0
      - REDIS_EXPIRATION=3600
      - MORK_URL=http://mork:8231
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=${NEO4J_USERNAME:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-atomspace123} 
      - LLM_MODEL=${LLM_MODEL:-gemini}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY} 
      - HURISTIC_SORT=False 
    networks:
      - atomspace-network

  # --- MongoDB (For Annotation) ---
  mongodb:
    image: mongo:latest
    container_name: mongodb
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongo_data:/data/db
    restart: always
    networks:
      - atomspace-network

  # --- Redis (For Annotation) ---
  redis:
    image: redis:latest
    container_name: redis
    volumes:
      - redis_data:/data
    restart: always
    networks:
      - atomspace-network

  # --- Annotation Tool (Frontend) ---
  annotation-tool:
    image: tarikua123/annotation-tool:latest
    container_name: annotation-tool
    ports:
      - "${ANNOTATION_TOOL_PORT:-3000}:${ANNOTATION_TOOL_PORT:-3000}"
    environment:
      - LOADER_URL=http://127.0.0.1:${ATOMSPACE_API_PORT:-8000}
      - ANNOTATION_URL=http://127.0.0.1:${ANNOTATION_SERVICE_PORT:-8001}
      - INTEGRATION_URL=http://127.0.0.1:${INTEGRATION_API_PORT:-9000}
    depends_on:
      - atomspace-api
      - annotation_service
    network_mode: host
    restart: always

  # --- Mork Pathmap ---
  mork:
    image: deazstar/custom-query-builder:mork-pathmap
    container_name: mork_pathmap
    ports:
      - "8231:8231"
    volumes:
      - ./MORK:/app # local code bind mount
      - ./custom-atomspace-builder/output:/shared/output # shared volume
    networks:
      - atomspace-network
    restart: always
  

  # --- Neo4j ---
  neo4j:
    image: neo4j:5.15-community
    container_name: neo4j-atomspace
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:7474"
      - "${NEO4J_BOLT_PORT:-7687}:7687"
    environment:
      - NEO4J_AUTH=${NEO4J_USERNAME:-neo4j}/${NEO4J_PASSWORD:-atomspace123}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_dbms_security_allow__csv__import__from__file__urls=true
      - NEO4J_dbms_directories_import=/var/lib/neo4j/import
      - NEO4J_dbms_memory_heap_initial__size=${NEO4J_HEAP_INITIAL:-512m}
      - NEO4J_dbms_memory_heap_max__size=${NEO4J_HEAP_MAX:-2G}
      - NEO4J_dbms_memory_pagecache_size=${NEO4J_PAGECACHE:-1G}
      - NEO4J_server_config_strict__validation_enabled=false
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - shared_output:/var/lib/neo4j/import/shared/output 
      - neo4j_plugins:/plugins
    networks:
      - atomspace-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "${NEO4J_USERNAME:-neo4j}", "-p", "${NEO4J_PASSWORD:-atomspace123}", "RETURN 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # --- Neural Subgraph Matcher Miner ---
  neural-miner:
    image: tarikua123/neural-miner:latest
    container_name: neurograph-ai-assistant-neural-miner
    volumes:
      - shared_output:/shared/output
    networks:
      - atomspace-network
    restart: always

  # --- Integration Service ---
  integration-service:
    image: tarikua123/integration-service:latest
    container_name: neurograph-ai-assistant-integration-service
    ports:
      - "${INTEGRATION_API_PORT:-9000}:9000"
    environment:
      - API_PORT=9000
      - ATOMSPACE_API_URL=http://atomspace-api:8000
      - NEURAL_MINER_URL=http://neural-miner:5000
      - ANNOTATION_SERVICE_URL=${ANNOTATION_SERVICE_URL:-http://annotation_service:8001}
      - ATOMSPACE_TIMEOUT=${ATOMSPACE_TIMEOUT:-600}
      - MINER_TIMEOUT=${MINER_TIMEOUT:-1800}
      - ANNOTATION_TIMEOUT=${ANNOTATION_TIMEOUT:-300}
      - CSV_CACHE_DIR=${CSV_CACHE_DIR:-./cache}
      - SHARED_VOLUME_PATH=/shared/output
    volumes:
      - shared_output:/shared/output
      - ./integration_service/output:/app/output
      - csv_cache:/tmp/csv_cache
    networks:
      - atomspace-network
    restart: always
    depends_on:
      - atomspace-api
      - neural-miner

volumes:
  neo4j_data:
  neo4j_logs:
  neo4j_plugins:
  hugegraph_data:
  hugegraph_logs:
  atomspace_logs:
  shared_output:
  mongo_data:
  redis_data:
  csv_cache:

networks:
  atomspace-network:
    driver: bridge